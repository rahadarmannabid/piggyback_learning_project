<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Kids Quiz | Piggyback</title>
  <style>
    body {
      margin: 0;
      font-family: "Comic Sans MS", "Poppins", sans-serif;
      background: #f3f9ff;
      color: #333;
    }

    h1 {
      background: #ff6f61;
      color: white;
      padding: 12px;
      margin: 0;
      text-align: center;
    }

    /* Library grid */
    #video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      padding: 16px;
      width: 90%;
      max-width: 1200px;
      margin: auto;
    }

    .video-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .video-card:hover {
      transform: scale(1.03);
    }

    .video-thumb {
      width: 100%;
      height: 140px;
      object-fit: cover;
    }

    .video-info {
      padding: 8px;
      font-size: 14px;
    }

    /* Quiz Shell */
    #quiz-shell {
      display: none;
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 9999;
      flex-direction: column;
    }

    /* FIXED: grid layout keeps title centered */
    #quiz-header {
      background: #ff6f61;
      color: white;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      padding: 10px 16px;
      font-size: 18px;
    }

    #quiz-header button {
      background: white;
      color: #ff6f61;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 16px;
    }

    #quiz-title {
      text-align: center;
    }

    #quiz-player {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
    }

    #player {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }

    /* Backdrop + modal */
    #backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .modal {
      background: #fff;
      border-radius: 24px;
      padding: 24px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      text-align: center;
      animation: popIn 0.25s ease;
    }

    .modal h2 {
      font-size: 22px;
      margin-bottom: 16px;
      color: #333;
    }

    .modal p {
      margin: 8px 0;
      font-size: 18px;
    }

    .modal button {
      margin-top: 12px;
      display: block;
      width: 100%;
      padding: 12px;
      font-size: 18px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: #ff6f61;
      color: white;
    }

    .btn-secondary {
      background: #f1f1f1;
      color: #333;
    }

    @keyframes popIn {
      from {
        transform: scale(0.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Mic pulse */
    #mic-indicator {
      margin: 12px auto;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ff6f61;
      display: none;
      animation: pulse 1.2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.3);
        opacity: 0.6;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    #confetti-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 11000;
    }

    /* End-of-Quiz Summary Styles */
    #summary-backdrop .modal {
      border-radius: 24px;
      padding: 24px;
    }

    #results-list li {
      padding: 8px 12px;
      margin: 6px 0;
      border-radius: 12px;
      background: #f9f9f9;
      font-size: 16px;
    }

    #results-list li.correct {
      background: #d4edda;
      color: #155724;
    }

    #results-list li.wrong {
      background: #f8d7da;
      color: #721c24;
    }

    #results-list li.almost {
      background: #fff3cd;
      color: #856404;
    }
  </style>
</head>

<body>
  <h1>Video Library</h1>
  <div id="video-grid"></div>

  <!-- Quiz Shell -->
  <div id="quiz-shell">
    <div id="quiz-header">
      <button id="exit-quiz">Exit Quiz</button>
      <span id="quiz-title"></span>
      <button id="results-btn" style="display:none;">See Results</button>
    </div>
    <div id="quiz-player">
      <video id="player" controls></video>
    </div>
  </div>

  <!-- Question Modal -->
  <div id="backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h2 id="question-text">Question goes here</h2>
      <div id="mic-indicator"></div>
      <p id="feedback"></p>
      <button id="answer-btn" class="btn-primary">Answer Now</button>
      <button id="continue-btn" class="btn-secondary" style="display:none;">Continue</button>
    </div>
  </div>

  <!-- Exit Confirmation Modal -->
  <div id="exit-backdrop"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10001; justify-content:center; align-items:center;">
    <div class="modal">
      <h2>Leave the quiz?</h2>
      <button id="stay-btn" class="btn-secondary">Stay</button>
      <button id="leave-btn" class="btn-primary">Leave</button>
    </div>
  </div>

  <!-- End-of-Quiz Summary -->
  <div id="summary-backdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6);
              z-index:10002; justify-content:center; align-items:center;">
    <div class="modal" style="max-width:700px; width:95%; text-align:center;">
      <h2>üéâ Quiz Complete!</h2>
      <p id="score-line" style="font-size:20px; font-weight:bold;">You got 0/0 correct</p>
      <ul id="results-list"
        style="list-style:none; padding:0; text-align:left; margin:16px auto; max-height:300px; overflow:auto;">
      </ul>
      <button id="replay-btn" class="btn-primary">Play Again</button>
      <button id="library-btn" class="btn-secondary">Back to Library</button>
    </div>
  </div>

  <!-- Completion Toast -->
  <div id="completion-toast" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
            background:#ff6f61; color:white; padding:12px 24px; border-radius:16px;
            font-size:18px; z-index:12000; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
    üéâ Quiz Complete! You can see your results anytime.
  </div>

  <!-- Confetti canvas -->
  <canvas id="confetti-canvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    let segments = {};
    let asked = new Set();
    let checkInterval = null;
    let activeQuestion = false;
    let previousTime = 0;
    let maxAllowedTime = 0;
    let skipLockBypass = false;

    let SKIP_PREVENTION = true; // will be updated by backend
    let THRESHOLDS = {};

    let results = []; // stores {question, expected, user, status}

    const player = document.getElementById("player");
    const videoGrid = document.getElementById("video-grid");
    const quizShell = document.getElementById("quiz-shell");
    const quizTitle = document.getElementById("quiz-title");
    const backdrop = document.getElementById("backdrop");
    const exitBackdrop = document.getElementById("exit-backdrop");

    // Confetti setup
    const confettiCanvas = document.getElementById("confetti-canvas");
    let shootConfetti = null;
    if (window.confetti && confettiCanvas) {
      // Tie confetti to our canvas; resize to window; use a worker for perf if available
      shootConfetti = window.confetti.create(confettiCanvas, { resize: true, useWorker: true });
    }

    // Prevent playback while a question is active
    player.addEventListener("play", (e) => {
      if (activeQuestion) {
        e.preventDefault?.();
        player.pause();
      }
    });

    async function loadConfig() {
      try {
        const res = await fetch("/api/config");
        const cfg = await res.json();
        SKIP_PREVENTION = cfg.skip_prevention;
        THRESHOLDS = cfg.thresholds;
        console.log("‚úÖ Config loaded:", cfg);
      } catch (err) {
        console.error("‚ö†Ô∏è Failed to load config, using defaults.", err);
      }
    }

    async function loadVideos() {
      try {
        const res = await fetch("/api/kids_videos?nocache=" + Date.now());
        const data = await res.json();
        if (!data.success) throw new Error("API error");
        videoGrid.innerHTML = "";
        data.videos.forEach(video => {
          const card = document.createElement("div");
          card.className = "video-card";
          card.innerHTML = `
          <img class="video-thumb" src="${video.thumbnail}" alt="Thumbnail">
          <div class="video-info">
            <p class="video-title">${video.title}</p>
          </div>
        `;
          card.onclick = () => startQuiz(video);
          videoGrid.appendChild(card);
        });
      } catch (err) {
        console.error("‚ùå Error loading kids_videos:", err);
        videoGrid.innerHTML = "<p>‚ö†Ô∏è Error loading videos.</p>";
      }
    }

    function resetSessionState() {
      asked = new Set();
      activeQuestion = false;
      previousTime = 0;
      maxAllowedTime = 0;
      skipLockBypass = false;
    }

    function startQuiz(video) {
      resetSessionState();
      videoGrid.style.display = "none";
      quizShell.style.display = "flex";
      quizTitle.innerText = video.title;
      player.src = video.local_path;
      player.play();

      // Try fullscreen

      fetch(`/static/questions.json?nocache=${Date.now()}`)
        .then(res => res.json())
        .then(data => {
          segments = data;
          startMonitoring();
        })
        .catch(err => console.error("‚ùå Failed to load questions:", err));
    }

    function startMonitoring() {
      clearInterval(checkInterval);
      checkInterval = setInterval(() => {
        let currentTime = Math.floor(player.currentTime);

        // --- Skip prevention ---
        if (SKIP_PREVENTION) {
          if (!skipLockBypass && currentTime > maxAllowedTime + 2) {
            console.warn("‚è™ Skip attempt detected!");
            player.currentTime = maxAllowedTime;
            return;
          }
          skipLockBypass = false;
          if (currentTime > maxAllowedTime) maxAllowedTime = currentTime;
        }

        if (activeQuestion) {
          previousTime = currentTime;
          return;
        }
        for (let segKey in segments) {
          let segment = segments[segKey];
          for (let key in segment) {
            if (!key.startsWith("question_")) continue;
            let q = segment[key];
            let quesTime = toSeconds(q.ques_time);
            if (previousTime < quesTime && currentTime >= quesTime && !asked.has(quesTime)) {
              askQuestion(q, segment);
              previousTime = currentTime;
              return;
            }
          }
        }
        previousTime = currentTime;
      }, 700);
    }

    function askQuestion(q, segment) {
      activeQuestion = true;
      player.pause();
      asked.add(toSeconds(q.ques_time));
      document.getElementById("question-text").innerText = q.question;
      document.getElementById("feedback").innerText = "";
      document.getElementById("answer-btn").onclick = () => startListening(q, segment);
      document.getElementById("continue-btn").style.display = "none";
      backdrop.style.display = "flex";
    }

    function startListening(q, segment) {
      const micIndicator = document.getElementById("mic-indicator");
      micIndicator.style.display = "block";
      document.getElementById("feedback").innerText = "Listening...";

      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        const mediaRecorder = new MediaRecorder(stream);
        let chunks = [];
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {
          micIndicator.style.display = "none";
          const blob = new Blob(chunks, { type: "audio/webm;codecs=opus" });
          const formData = new FormData();
          formData.append("file", blob, "speech.webm");
          fetch("/api/transcribe", { method: "POST", body: formData })
            .then(res => res.json())
            .then(data => {
              const spoken = (data.text || "").trim();
              document.getElementById("feedback").innerText = spoken ? `You said: "${spoken}"` : "‚ö†Ô∏è Didn't catch that.";
              checkAnswer(spoken, q, segment);
            })
            .catch(err => {
              console.error("‚ùå Transcription failed:", err);
              document.getElementById("feedback").innerText = "‚ö†Ô∏è Didn't catch that.";
              // Optional: rewind on no transcript as well
            });
        };
        mediaRecorder.start();
        // Give kids more time to finish (10s). Adjust as needed.
        setTimeout(() => mediaRecorder.stop(), 10000);
      });
    }

    function checkAnswer(spoken, q, segment) {
      fetch("/api/check_answer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          expected: q.answer,
          user: spoken,
          question: q.question
        })
      })
        .then(res => res.json())
        .then(data => {
          const feedbackEl = document.getElementById("feedback");
          const status = data.status || "wrong";
          const sim = parseFloat(data.similarity || 0);
          console.log(`üìä Similarity=${sim}, Thresholds=`, THRESHOLDS);
          console.log("‚úÖ Local check response:", data);

          results.push({
            question: q.question,
            expected: q.answer,
            user: spoken,
            status: status
          });

          if (status === "correct") {
            feedbackEl.innerText = "‚úÖ Correct!";
            feedbackEl.style.color = "green";

            // Fireworks celebration (1.5s)
            if (shootConfetti) {
              const end = Date.now() + 1500;
              (function frame() {
                shootConfetti({
                  particleCount: 7,
                  angle: 60,
                  spread: 65,
                  startVelocity: 45,
                  origin: { x: 0, y: 0.7 }
                });
                shootConfetti({
                  particleCount: 7,
                  angle: 120,
                  spread: 65,
                  startVelocity: 45,
                  origin: { x: 1, y: 0.7 }
                });
                if (Date.now() < end) requestAnimationFrame(frame);
              })();
            }

            setTimeout(() => {
              closeQuestionModal();
              player.play();
            }, 800);

          } else if (status === "almost" || status === "wrong") {
            feedbackEl.innerText = status === "almost" ? "ü§î Almost, try again!" : "‚ùå Wrong, rewinding...";
            feedbackEl.style.color = status === "almost" ? "orange" : "red";

            setTimeout(() => {
              // rewind to segment start
              const segStart = toSeconds(segment.segment_range_start);
              skipLockBypass = true; // bypass skip-prevention for programmatic seek
              for (let time of [...asked]) {
                if (time >= segStart && time <= toSeconds(segment.segment_range_end)) {
                  asked.delete(time);
                }
              }
              player.currentTime = segStart;
              closeQuestionModal();
              player.play();
            }, 1500);
          } else {
            // Safe fallback
            feedbackEl.innerText = "‚ö†Ô∏è Could not check answer.";
            feedbackEl.style.color = "gray";
            setTimeout(() => {
              closeQuestionModal();
              player.play();
            }, 1000);
          }

          // Check if all questions answered
          let totalQuestions = Object.values(segments)
            .map(seg => Object.keys(seg).filter(k => k.startsWith("question_")).length)
            .reduce((a, b) => a + b, 0);

          if (results.length >= totalQuestions) {
            // Show toast + enable results button
            document.getElementById("results-btn").style.display = "inline-block";
            const toast = document.getElementById("completion-toast");
            toast.style.display = "block";
            setTimeout(() => { toast.style.display = "none"; }, 3000);

            // Also hook into video end for auto summary
            player.onended = () => showSummary();
          }
        })
        .catch(err => {
          console.error("‚ö†Ô∏è Answer check failed:", err);
          document.getElementById("feedback").innerText = "‚ö†Ô∏è Could not check answer.";
          setTimeout(() => {
            closeQuestionModal();
            player.play();
          }, 1000);
        });
    }

    function closeQuestionModal() {
      backdrop.style.display = "none";
      activeQuestion = false;
    }

    function toSeconds(timeStr) {
      if (!timeStr) return 0;
      const parts = timeStr.split(":").map(Number);
      if (parts.length === 2) return parts[0] * 60 + parts[1];
      if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
      return Number(timeStr) || 0;
    }


    function showSummary() {
      const summary = document.getElementById("summary-backdrop");
      const scoreLine = document.getElementById("score-line");
      const resultsList = document.getElementById("results-list");

      const correctCount = results.filter(r => r.status === "correct").length;
      scoreLine.innerText = `You got ${correctCount}/${results.length} correct!`;

      resultsList.innerHTML = "";
      results.forEach(r => {
        const li = document.createElement("li");
        li.className = r.status;
        li.innerHTML = `
      <strong>Q:</strong> ${r.question}<br>
      <strong>You said:</strong> ${r.user || "(no answer)"}<br>
      <strong>Expected:</strong> ${r.expected}<br>
      <em>Result: ${r.status}</em>
    `;
        resultsList.appendChild(li);
      });

      summary.style.display = "flex";
    }

    // Exit quiz flow
    document.getElementById("exit-quiz").onclick = () => {
      exitBackdrop.style.display = "flex";
    };
    document.getElementById("stay-btn").onclick = () => {
      exitBackdrop.style.display = "none";
    };
    document.getElementById("leave-btn").onclick = () => {
      player.pause();
      clearInterval(checkInterval);
      quizShell.style.display = "none";
      videoGrid.style.display = "grid";
      exitBackdrop.style.display = "none";
      if (document.fullscreenElement) {
        document.exitFullscreen().catch(() => { });
      }
    };
    document.getElementById("replay-btn").onclick = () => {
      location.reload(); // resets everything
    };

    document.getElementById("library-btn").onclick = () => {
      player.pause();
      clearInterval(checkInterval);
      quizShell.style.display = "none";
      videoGrid.style.display = "grid";
      document.getElementById("summary-backdrop").style.display = "none";
    };

    document.getElementById("results-btn").onclick = () => {
      player.pause();
      showSummary();
    };

    // Init
    loadConfig();
    loadVideos();
  </script>
</body>

</html>